on:
  pull_request:
  push:
jobs:
  sbuild:
    runs-on: ubuntu-latest
    services:
      aptcache:
        image: sameersbn/apt-cacher-ng
        ports:
        - 3142:3142
    strategy:
      matrix:
        distribution:
        - codename: trixie
          mirror: http://deb.debian.org/debian/
          keyring:
            package: debian-archive-keyring
            path: /usr/share/keyrings/debian-archive-keyring.gpg
        arch:
        - deb: amd64
          qemu: amd64
        - deb: arm64
          qemu: aarch64
    steps:
    - run: >-
        echo 'Acquire::http::Proxy "http://localhost:3142";'
        | sudo tee /etc/apt/apt.conf.d/01proxy
    - run: sudo apt-get update
    - run: >-
        sudo apt-get install -y --no-install-recommends
        sbuild
        schroot
        mmdebstrap
        ${{ matrix.distribution.keyring.package }}
        qemu-user-static
        binfmt-support
        arch-test
        debhelper
        devscripts
    - run: echo "$SBUILD_CONF" > ~/.sbuildrc
      env:
        SBUILD_CONF: |-
          # Set the chroot mode to be unshare.
          $chroot_mode = 'unshare';

          # Build Architecture: all packages; this is the same as passing `-A` to sbuild.
          $build_arch_all = 1;

          # Build the source in addition to the other requested build artifacts.
          # Without this, <BINARY>.changes files will not include the upstream source in
          # their list and will fail uploads to Debian if they are for a -1 revision that
          # includes a new upstream release; this is the same as passing `-s` to sbuild.
          $build_source = 1;

          # Produce a source.changes file suitable for a source-only upload;
          # this is the same as passing `--source-only-changes` to sbuild.
          $source_only_changes = 1;

          ## Run lintian after every build (in the same chroot as the build); use --no-run-lintian to override.
          $run_lintian = 1;
          # Display info tags.
          $lintian_opts = ['--display-info', '--verbose', '--fail-on', 'error,warning', '--info'];
    - if: matrix.arch.qemu != 'amd64'
      run: sudo update-binfmts --enable qemu-${{ matrix.arch.qemu }}
    - uses: actions/checkout@v4

    - id: cache-mmdebstrap-restore
      uses: actions/cache/restore@v4
      with:
        key: ${{ matrix.distribution.codename }}-${{ matrix.arch.deb }}.tar.zst
        path: .cache/sbuild/${{ matrix.distribution.codename }}-${{ matrix.arch.deb }}.tar.zst
    - if: steps.cache-mmdebstrap-restore.outputs.cache-hit != 'true'
      run: mkdir -p .cache/sbuild
    - if: steps.cache-mmdebstrap-restore.outputs.cache-hit != 'true'
      run: >-
        mmdebstrap
        --skip=output/dev
        --variant=buildd
        --arch=${{ matrix.arch.deb }}
        --keyring=${{ matrix.distribution.keyring.path }}
        --aptopt='Acquire::http::Proxy "http://localhost:3142";'
        ${{ matrix.distribution.codename }}
        .cache/sbuild/${{ matrix.distribution.codename }}-${{ matrix.arch.deb }}.tar.zst
        ${{ matrix.distribution.mirror }}
    - if: steps.cache-mmdebstrap-restore.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        key: ${{ matrix.distribution.codename }}-${{ matrix.arch.deb }}.tar.zst
        path: .cache/sbuild/${{ matrix.distribution.codename }}-${{ matrix.arch.deb }}.tar.zst

    - run: mkdir -p out
    - run: >-
        sbuild
        --nolog
        --build-dir=out
        --dist=${{ matrix.distribution.codename }}
        --arch=${{ matrix.arch.deb }}
        --chroot=$PWD/.cache/sbuild/${{ matrix.distribution.codename }}-${{ matrix.arch.deb }}.tar.zst

    - uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.distribution.codename }}-${{ matrix.arch.deb }}
        path: out/
